# 发送短信

短信服务模块提供了短信验证码发送功能，用于用户注册、登录等场景的验证码发送。支持 IP 限流、每日发送次数限制等安全机制。

## 发送短信验证码

### 接口地址

**接口地址**：`POST /api/sms/send`

### 请求头

```
Authorization: Bearer {token}
Content-Type: application/json
```

### 请求参数

```json
{
  "mobile": "13800138000"
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| mobile | string | 是 | 手机号码，格式：1[3-9]开头的11位数字 |

### 响应示例

**成功响应**：

```json
{
  "code": 200,
  "message": "验证码发送成功",
  "data": {
    "mobile": "13800138000",
    "code": "123456",
    "expire": 5
  }
}
```

**响应参数说明**：

| 参数名 | 类型 | 说明 |
|--------|------|------|
| mobile | string | 手机号码 |
| code | string | 验证码（开发阶段返回，生产环境应移除） |
| expire | int | 验证码过期时间（分钟） |

**错误响应**：

```json
{
  "code": 400,
  "message": "手机号格式不正确"
}
```

常见错误码：

- `400`：手机号格式不正确
- `429`：请求过于频繁，请 {剩余秒数} 秒后再试
- `429`：今天发送次数已达上限（10次），请明天再试

## 功能特性

### 验证码生成与存储

- **验证码格式**：6位随机数字（000000-999999）
- **存储方式**：使用 Redis 存储验证码
- **存储 Key**：`sms:code:{手机号}`
- **过期时间**：5分钟
- **自动清理**：验证码过期后自动从 Redis 中删除

### IP 频繁请求限制

- **时间窗口**：60秒
- **最大请求次数**：3次
- **限制范围**：按 IP 地址限制
- **存储 Key**：`sms:ip:{IP地址}`
- **错误提示**：超过限制时返回剩余等待时间（秒）

### 每天请求总次数限制

- **限制次数**：每个手机号每天最多发送 10 次验证码
- **时间范围**：按自然日计算（00:00:00 - 23:59:59）
- **存储 Key**：`sms:daily:{手机号}:{日期}`
- **自动清理**：每天 0 点自动清理前一天的记录
- **错误提示**：超过限制时提示"今天发送次数已达上限（10次），请明天再试"

## 工作流程

1. **验证手机号格式**
   - 验证手机号是否为空
   - 验证手机号格式是否正确（1[3-9]开头的11位数字）

2. **检查 IP 频繁请求限制**
   - 检查当前 IP 在 60 秒内的请求次数
   - 如果超过 3 次，返回错误并提示剩余等待时间

3. **检查当天手机号请求总次数限制**
   - 检查当前手机号当天的请求次数
   - 如果超过 10 次，返回错误提示

4. **生成验证码**
   - 生成 6 位随机数字验证码
   - 使用 `str_pad()` 确保验证码始终为 6 位（不足补零）

5. **存储验证码到 Redis**
   - 使用 `Cache::store('redis')` 存储验证码
   - 设置过期时间为 5 分钟

6. **记录 IP 请求次数**
   - 增加当前 IP 的请求计数
   - 设置过期时间为 60 秒

7. **记录当天手机号请求次数**
   - 增加当前手机号当天的请求计数
   - 设置过期时间为当天结束时间

8. **返回验证码**
   - 返回验证码信息（开发阶段）
   - 生产环境应移除验证码返回，仅提示发送成功

## 限流规则

### IP 限流规则

- **时间窗口**：60 秒
- **最大请求次数**：3 次
- **限制范围**：按 IP 地址
- **错误提示**：`请求过于频繁，请 {剩余秒数} 秒后再试`

### 每天限流规则

- **限制次数**：每个手机号每天最多 10 次
- **时间范围**：自然日（00:00:00 - 23:59:59）
- **限制范围**：按手机号
- **错误提示**：`今天发送次数已达上限（10次），请明天再试`

### 验证码规则

- **验证码长度**：6 位数字
- **有效期**：5 分钟
- **存储位置**：Redis
- **自动清理**：过期后自动删除

## 技术实现

### 技术栈

- **框架**：Laravel
- **缓存**：Redis（通过 Laravel Cache）
- **存储驱动**：`Cache::store('redis')`

### Redis Key 设计

| Key 格式 | 说明 | 过期时间 |
|----------|------|----------|
| `sms:code:{手机号}` | 验证码存储 | 5 分钟 |
| `sms:ip:{IP地址}` | IP 请求次数 | 60 秒 |
| `sms:daily:{手机号}:{日期}` | 当天请求次数 | 当天结束 |

### 代码结构

```php
// 主要方法
- sendSms()           // 发送短信验证码主方法
- checkIpLimit()      // 检查 IP 频繁请求限制
- checkDailyLimit()   // 检查当天请求总次数限制
- incrementDailyCount() // 增加当天请求次数
- generateCode()      // 生成6位随机验证码
```

## 使用示例

### 前端调用示例

```typescript
import { request } from '@umijs/max';

// 发送短信验证码
export async function sendSmsCode(params: { mobile: string }) {
  return request('/api/sms/send', {
    method: 'POST',
    data: params,
  });
}
```

## 注意事项

1. **开发环境**：当前返回验证码用于测试，生产环境应移除验证码返回
2. **短信服务**：TODO 标记处需要接入实际的短信服务商 API
3. **Redis 配置**：确保 Redis 服务正常运行
4. **时区设置**：确保服务器时区正确，以便准确计算当天结束时间
5. **错误处理**：所有限制检查失败都会抛出异常，由框架统一处理

## 后续优化建议

1. **短信服务接入**：接入阿里云、腾讯云等短信服务商
2. **验证码验证接口**：提供验证码验证接口
3. **发送记录**：记录发送日志到数据库
4. **统计功能**：提供发送统计接口
5. **白名单机制**：支持配置白名单手机号，不受限制
6. **验证码类型**：支持不同类型的验证码（注册、登录、找回密码等）
